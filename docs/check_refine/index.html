<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Check & Refine Tool – Overview</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <nav>
      <h1>Check & Refine</h1>
      <div class="search-box">
        <input id="q" placeholder="Filter nav..." oninput="filterNav(this.value)" />
      </div>
      
      <ul>
        <li><a href="index.html">Overview</a></li>
        <li>
          <a href="schema.html">JSON Schema</a>
          <ul>
            <li><a href="examples.html">Types</a></li>
            <li><a href="errors_warnings.html">Rules</a></li>
          </ul>
        </li>
        <li><a href="timers.html">Timers</a></li>
        <li><a href="dma.html">DMA</a></li>
      </ul>
    </nav>
    <main>
      <h1>Configuration Check &amp; Refine Pipeline</h1>
      <p>
        This documentation describes the preprocessing stage that converts a raw board + project JSON into a
        <strong>refined</strong> canonical configuration consumed by the code generator. The goal: push every
        validation, inference, and defaulting decision into one deterministic step.
      </p>
      <div class="note">
        <strong>Core Principle:</strong> Generation assumes the refined JSON is valid &amp; complete. No defensive
        logic inside the templates.
      </div>
      <h2>High‑Level Flow</h2>
      <ol>
        <li><strong>Load Inputs:</strong> Raw project JSON + board capability JSON.</li>
        <li>
          <strong>Normalize &amp; Expand:</strong> Apply field canonicalization, alias handling, numeric bounds, and
          dependency enforcement.
        </li>
        <li>
          <strong>Hardware Validation:</strong> Timer existence, channel count, trigger capability, DMA resource
          mapping.
        </li>
        <li>
          <strong>DMA Resolution:</strong> For each DMA request pattern build explicit (name, channel, stream)
          selection, prune unused definitions.
        </li>
        <li>
          <strong>Timer Refinement:</strong> Master/slave gating, trigger mapping (ITR indices), interrupt
          consistency, overwrite ( _OW_ ) ordering.
        </li>
        <li>
          <strong>Ordering &amp; Output:</strong> Deterministic key order for diff friendly output, removing invalid
          timers/DMAs.
        </li>
      </ol>
      <h2>Design Objectives</h2>
      <ul>
        <li><strong>Determinism:</strong> Same input set =&gt; identical refined output.</li>
        <li><strong>Hardware Awareness:</strong> All limits derive from board JSON not hardcoded magic numbers.</li>
        <li>
          <strong>User Ergonomics:</strong> Accept flexible partial specs (e.g. only <code>request</code>) while
          forbidding ambiguous results.
        </li>
        <li>
          <strong>Strictness:</strong> Invalid constructs removed with explicit error list (fast fail); warnings only
          for safe coercions.
        </li>
        <li>
          <strong>Minimal Generation Logic:</strong> Templates contain straightforward conditionals; complex reasoning
          lives here.
        </li>
      </ul>
      <h2>Refinement Guarantees</h2>
      <div class="grid">
        <div class="okbox note">
          <h3>Canonical Fields</h3>
          <p>Every timer/dma field appears in a normalized form (uppercase enums, trimmed keys, numeric bounds enforced).</p>
        </div>
        <div class="okbox note">
          <h3>Dependency Safety</h3>
          <p><code>slave_mode</code> only present with valid <code>trigger_source</code>; interrupts only when aligned with <code>irq_handler</code>.</p>
        </div>
        <div class="okbox note">
          <h3>Pruned Invalids</h3>
          <p>Timers outside board spec, unsupported triggers, impossible DMA mappings removed before generation.</p>
        </div>
        <div class="okbox note">
          <h3>Deterministic Order</h3>
          <p>Alias groups reorder keys for stable diffs and review.</p>
        </div>
      </div>
      <h2>Input vs Output</h2>
      <p>
        Raw JSON may contain omissions, mixed casing, aliases, partially specified DMA triplets, extraneous timers, or unused DMA objects.
        The refined JSON eliminates ambiguity:
      </p>
      <pre>{
  "timers": {
    "TIM2": {
      "request": "TIM2_CH1",
      "channel": 1,
      "period": 1000,
      "prescaler": 0,
      "counter_mode": "UP",
      "auto_reload_preload": "DISABLE",
      "master_output_trigger": "RESET",
      "master_slave_mode": "DISABLE",
      "interrupt": true,
      "irq_handler": "TIM2_IRQHandler"
    }
  },
  "dmas": {
    "DMA_TIM2_CH1": {
      "name": "DMA_TIM2_CH1",
      "request": "TIM2_CH1",
      "direction": "PERIPH_TO_MEMORY",
      "dma": 1,
      "stream": 0,
      "channel": 3
    }
  }
}</pre>
      <p>(Illustrative sample; actual channel/stream values depend on board mapping.)</p>
      <h2>Board Capability JSON</h2>
      <p>The board file contributes:</p>
      <ul>
        <li>
          Timer catalog with: <code>type</code> (basic/general/advanced), <code>channels</code>, <code>period_bits</code>,
          <code>trigger_source</code> list, <code>trigger_output</code> boolean.
        </li>
        <li>
          DMA mapping table resolving peripheral requests to one or more concrete DMA (controller/channel/stream)
          combos.
        </li>
      </ul>
      <h2>Extensibility</h2>
      <p>
        To add a new MCU family: extend the board JSON with its timer and DMA capability descriptors; the refinement logic auto-adapts (no core code change unless new semantic categories arise).
      </p>
      <h2>Diagnostics Philosophy</h2>
      <p>
        Errors remove entities. Warnings adjust values (e.g., clamp numeric out-of-range) while preserving intent. See
        <a href="errors_warnings.html">Errors &amp; Warnings</a>.
      </p>
      <h2>Next Pages</h2>
      <ul>
        <li><a href="schema.html">Schema</a>: Precise field definitions &amp; allowed values.</li>
        <li><a href="timers.html">Timers</a>: Field-by-field refinement rules.</li>
        <li><a href="dma.html">DMA</a>: Mapping, selection logic, pruning.</li>
        <li><a href="examples.html">Examples</a>: Before/after scenarios.</li>
      </ul>
      <footer>Generated documentation scaffold – customize as needed.</footer>
    </main>
    <script>
      function filterNav(v) {
        v = v.toLowerCase();
        for (const a of document.querySelectorAll('nav a')) {
          if (a.textContent.toLowerCase().includes(v) || a.getAttribute('href').includes(v)) {
            a.style.display = 'block';
          } else {
            a.style.display = 'none';
          }
        }
      }
    </script>
  </body>
</html>
