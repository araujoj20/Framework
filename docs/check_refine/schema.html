<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>Schema – Check &amp; Refine</title>
		<link rel="stylesheet" href="style.css" />
	</head>
	<body>
		<nav>
			<h1>Check &amp; Refine</h1>
			<div class="search-box">
				<input id="q" placeholder="Filter nav..." oninput="filterNav(this.value)" />
			</div>
			<a href="index.html">Overview</a>
			<a class="active" href="schema.html">JSON Schema</a>
			<a href="timers.html">Timers</a>
			<a href="dma.html">DMA</a>
			<a href="errors_warnings.html">Errors &amp; Warnings</a>
			<a href="examples.html">Examples</a>
		</nav>
		<main>
			<h1>Top-Level JSON Schema</h1>
			<p>
				The refinement tool ingests a project configuration JSON with two principal objects: <code>timers</code> and
				<code>dmas</code>. Additional metadata may be ignored unless explicitly referenced.
			</p>
			<h2>Root Object</h2>
			<table>
				<thead>
					<tr>
						<th>Key</th>
						<th>Type</th>
						<th>Required</th>
						<th>Description</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td><code>timers</code></td>
						<td>object</td>
						<td>yes</td>
						<td>Timer instances keyed by user (possibly aliased) names (e.g. <code>TIM2</code>, <code>TIM3_OW_1</code>).</td>
					</tr>
					<tr>
						<td><code>dmas</code></td>
						<td>object</td>
						<td>no</td>
						<td>DMA descriptors keyed by a user-chosen name; may be pruned.</td>
					</tr>
				</tbody>
			</table>
			<h2>Timer Object Schema</h2>
			<table>
				<thead>
					<tr>
						<th>Field</th>
						<th>Type</th>
						<th>Required</th>
						<th>Allowed / Format</th>
						<th>Notes</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td><code>request</code></td>
						<td>string</td>
						<td>yes*</td>
						<td><code>TIMx_UP</code>, <code>TIMx_CHy</code>, <code>TIMx_TRIG</code>, family-specific variants</td>
						<td>Must match timer; used for DMA linking decisions. Required unless purely software timer logic.</td>
					</tr>
					<tr>
						<td><code>channel</code></td>
						<td>int</td>
						<td>auto</td>
						<td>1..N (N=board timer channels)</td>
						<td>Derived from <code>request</code> if <code>CHy</code>; removed if not applicable.</td>
					</tr>
					<tr>
						<td><code>period</code></td>
						<td>int</td>
						<td>no</td>
						<td>0..(2^bits -1)</td>
						<td>Clamped; bits from board (<code>period_bits</code>). Default left unspecified in refined if absent?</td>
					</tr>
						<tr>
						<td><code>prescaler</code></td>
						<td>int</td>
						<td>no</td>
						<td>0..65535</td>
						<td>Clamped if outside bounds.</td>
					</tr>
					<tr>
						<td><code>counter_mode</code></td>
						<td>string</td>
						<td>no</td>
						<td>UP | DOWN | CENTERALIGNED1/2/3</td>
						<td>Normalized uppercase. Invalid removed -&gt; error.</td>
					</tr>
					<tr>
						<td><code>auto_reload_preload</code></td>
						<td>string</td>
						<td>no</td>
						<td>ENABLE | DISABLE</td>
						<td>Applies only if timer type allows ARR preload.</td>
					</tr>
					<tr>
						<td><code>master_output_trigger</code></td>
						<td>string</td>
						<td>no</td>
						<td>RESET | UPDATE | OC1REF | OC2REF | OC3REF | OC4REF | ENABLE (family-specific)</td>
						<td>Only for timers with <code>trigger_output=true</code>. Default RESET if unspecified &amp; capability present.</td>
					</tr>
					<tr>
						<td><code>master_slave_mode</code></td>
						<td>string</td>
						<td>no</td>
						<td>ENABLE | DISABLE</td>
						<td>Removed for BASIC timers.</td>
					</tr>
					<tr>
						<td><code>slave_mode</code></td>
						<td>string</td>
						<td>no</td>
						<td>DISABLE | RESET | GATED | TRIGGER | EXTERNAL1 (subset)</td>
						<td>Only if <code>trigger_source</code> valid &amp; board supports slave for timer.</td>
					</tr>
					<tr>
						<td><code>trigger_source</code></td>
						<td>string</td>
						<td>conditional</td>
						<td>One of board-listed sources (e.g. <code>TIM1</code>, <code>ITR1</code>, etc.)</td>
						<td>Required if <code>slave_mode!=DISABLE</code>. Maps to ITR index.</td>
					</tr>
					<tr>
						<td><code>interrupt</code></td>
						<td>bool</td>
						<td>no</td>
						<td>true|false</td>
						<td>If true, must have consistent <code>irq_handler</code> or auto-derived; mismatches trimmed.</td>
					</tr>
					<tr>
						<td><code>irq_handler</code></td>
						<td>string</td>
						<td>no</td>
						<td>C identifier</td>
						<td>If provided without <code>interrupt</code>, logic may enable or warn depending on rule version.</td>
					</tr>
				</tbody>
			</table>
			<h2>DMA Object Schema</h2>
			<table>
				<thead>
					<tr>
						<th>Field</th>
						<th>Type</th>
						<th>Required</th>
						<th>Allowed / Format</th>
						<th>Notes</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td><code>request</code></td>
						<td>string</td>
						<td>yes</td>
						<td>Peripheral signal name (e.g. <code>TIM2_CH1</code>)</td>
						<td>Mapped via board <code>dma_mapping</code>.</td>
					</tr>
					<tr>
						<td><code>direction</code></td>
						<td>string</td>
						<td>yes</td>
						<td>PERIPH_TO_MEMORY | MEMORY_TO_PERIPH | MEMORY_TO_MEMORY</td>
						<td>Impacts constraints (channel=0 for MEMORY_TO_MEMORY on some families).</td>
					</tr>
					<tr>
						<td><code>dma</code></td>
						<td>int</td>
						<td>auto/yes</td>
						<td>Controller index (1..M)</td>
						<td>Chosen from mapping; may be user-preselected.</td>
					</tr>
					<tr>
						<td><code>stream</code></td>
						<td>int</td>
						<td>family</td>
						<td>0..7 (STM32F4)</td>
						<td>Families w/o streams omit; validated if present.</td>
					</tr>
					<tr>
						<td><code>channel</code></td>
						<td>int</td>
						<td>auto/yes</td>
						<td>0..7 (range board/family)</td>
						<td>Unique combination enforced for MEMORY_TO_MEMORY (or other policies).</td>
					</tr>
					<tr>
						<td><code>name</code></td>
						<td>string</td>
						<td>no</td>
						<td>Identifier</td>
						<td>Preserved if supplied; auto-filled if missing.</td>
					</tr>
				</tbody>
			</table>
			<h2>Board Capability Schema</h2>
			<table>
				<thead>
					<tr>
						<th>Key</th>
						<th>Type</th>
						<th>Description</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td><code>timers</code></td>
						<td>object</td>
						<td>Map of base timer names to capability descriptors.</td>
					</tr>
					<tr>
						<td><code>dma_mapping</code></td>
						<td>object</td>
						<td>Peripheral request -&gt; list of mapping variants (<code>dma</code>, <code>channel</code>, optional <code>stream</code>).</td>
					</tr>
				</tbody>
			</table>
			<h3>Timer Capability Descriptor</h3>
			<table>
				<thead>
					<tr>
						<th>Field</th>
						<th>Type</th>
						<th>Description</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td><code>type</code></td>
						<td>string</td>
						<td>BASIC | GENERAL | ADVANCED (controls feature gating).</td>
					</tr>
					<tr>
						<td><code>channels</code></td>
						<td>int</td>
						<td>Max channel count (for CHy request bounds).</td>
					</tr>
					<tr>
						<td><code>period_bits</code></td>
						<td>int</td>
						<td>Valid period width (e.g. 16 or 32).</td>
					</tr>
					<tr>
						<td><code>trigger_source</code></td>
						<td>array</td>
						<td>List of permissible upstream sources (timer names or internal triggers).</td>
					</tr>
					<tr>
						<td><code>trigger_output</code></td>
						<td>bool</td>
						<td>If false, master_output_trigger omitted/reset.</td>
					</tr>
				</tbody>
			</table>
			<h2>Refined Output Differences</h2>
			<ul>
				<li>Removed invalid timers (nonexistent, mismatched request, unsupported slave/trigger combos).</li>
				<li>Removed orphan DMAs not referenced by any timer.</li>
				<li>Added resolved numeric fields (<code>channel</code>, <code>dma</code>, <code>stream</code>) where inferred.</li>
				<li>Normalized enum casing &amp; value sets.</li>
				<li>Deterministic key ordering inside each timer/DMA object.</li>
			</ul>
			<h2>Aliases</h2>
			<p>
				Alias groups let users write variations (e.g. <code>MasterOutputTrigger</code>, <code>master_output_trigger</code>,
				<code>masterOutputTrigger</code>); refinement keeps only one canonical key while preserving user’s chosen form
				where design requires. Exact list driven by internal <code>FIELD_SPECS</code>.
			</p>
			<h2>Validation Strategy</h2>
			<ul>
				<li><strong>Error:</strong> Field/timer/DMA removed with diagnostic entry.</li>
				<li><strong>Warning:</strong> Value coerced (case normalization, numeric clamp).</li>
				<li><strong>Pass-through:</strong> Unknown fields may be dropped (future-proof) to retain strictness.</li>
			</ul>
			<footer>Schema documentation scaffold.</footer>
		</main>
		<script>
			function filterNav(v) {
				v = v.toLowerCase();
				for (const a of document.querySelectorAll('nav a')) {
					if (a.textContent.toLowerCase().includes(v) || a.getAttribute('href').includes(v)) {
						a.style.display = 'block';
					} else {
						a.style.display = 'none';
					}
				}
			}
		</script>
	</body>
</html>
