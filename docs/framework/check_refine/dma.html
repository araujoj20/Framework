<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>DMA – Check &amp; Refine</title>
    <link rel="stylesheet" href="../style.css" />
  </head>
  <body>
    <main>
      <h1>DMA Refinement &amp; Mapping</h1>
      <p>
        DMA objects provide explicit data movement configuration for peripheral timer requests. The refinement step converts
        flexible user input into precise controller/channel(/stream) selections with enforced uniqueness and direction
        constraints.
      </p>
      <h2>User Flexibility</h2>
      <p>The user may specify:</p>
      <ul>
        <li>Only <code>request</code> &amp; <code>direction</code></li>
        <li><code>request</code> + preselected <code>dma</code> controller</li>
        <li>Full triplet (<code>dma</code>, <code>channel</code>, <code>stream</code>)</li>
      </ul>
      <p>Refinement supplements missing fields using board <code>dma_mapping</code>.</p>
      <h2>Board Mapping Structure</h2>
      <pre>"dma_mapping": {
  "TIM2_CH1": [ {"dma":1, "stream":0, "channel":3}, {"dma":1, "stream":5, "channel":3} ],
  "TIM2_UP":  [ {"dma":1, "stream":1, "channel":3} ]
}</pre>
      <p>Each variant is a permissible routing. Streams may be absent on families without the concept (non-F4/L4 etc.).</p>
      <h2>Selection Algorithm</h2>
      <ol>
        <li>Collect all DMA objects grouped by <code>request</code>.</li>
        <li>For each group, match any user-specified subset against candidate variants:</li>
      </ol>
      <table>
        <thead>
          <tr>
            <th>Case</th>
            <th>Resolution</th>
            <th>Ambiguity Handling</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>No controller/channel specified</td>
            <td>Pick first variant (stable order)</td>
            <td>Warn if multiple available</td>
          </tr>
          <tr>
            <td>Controller only</td>
            <td>Filter variants by <code>dma</code>, then pick first</td>
            <td>Error if none</td>
          </tr>
          <tr>
            <td>Controller + channel</td>
            <td>Require exact match (ignoring stream if family w/o)</td>
            <td>Error if none</td>
          </tr>
            <tr>
            <td>Full triplet</td>
            <td>Validate against list</td>
            <td>Error if not found</td>
          </tr>
        </tbody>
      </table>
      <h2>Direction Constraints</h2>
      <ul>
        <li><code>MEMORY_TO_MEMORY</code> may enforce <code>channel=0</code> + mandatory stream for certain families (e.g. STM32F4 policy).</li>
        <li>Violations =&gt; error removal.</li>
      </ul>
      <h2>Uniqueness &amp; Pruning</h2>
      <ul>
        <li>
          Duplicate MEMORY_TO_MEMORY resource (same dma/channel/stream) =&gt; subsequent duplicates removed (warning or error depending
          strictness).
        </li>
        <li>DMA definitions not referenced by any timer after refinement are pruned.</li>
      </ul>
      <h2>Field Normalization</h2>
      <table>
        <thead>
          <tr>
            <th>Field</th>
            <th>Rule</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><code>direction</code></td>
            <td>Uppercased; must be in allowed set.</td>
          </tr>
          <tr>
            <td><code>name</code></td>
            <td>Auto-filled if absent: pattern <code>DMA_{request}</code>.</td>
          </tr>
          <tr>
            <td><code>request</code></td>
            <td>Uppercased; must exist in board mapping; else DMA removed.</td>
          </tr>
          <tr>
            <td><code>dma</code></td>
            <td>Integer controller index validated against variant list.</td>
          </tr>
          <tr>
            <td><code>channel</code></td>
            <td>Range-checked (family-specific max).</td>
          </tr>
          <tr>
            <td><code>stream</code></td>
            <td>Only retained when family supports streams; value validated.</td>
          </tr>
        </tbody>
      </table>
      <h2>Families Without Streams</h2>
      <p>
        If board mapping variants omit <code>stream</code>, refinement removes any user-provided stream field to avoid confusion
        (warning).
      </p>
      <h2>Example</h2>
      <pre>// Raw
"dmas": {
  "tim2ch1": {
    "request":"tim2_ch1",
    "direction":"periph_to_memory"
    }
}
// Refined (F4 style)
"dmas": {
  "tim2ch1": {
    "request": "TIM2_CH1",
    "direction": "PERIPH_TO_MEMORY",
    "dma": 1,
    "stream": 0,
    "channel": 3,
    "name": "tim2ch1"
  }
}</pre>
      <h2>Error Removal Examples</h2>
      <ul>
        <li>Request not in mapping.</li>
        <li>User-specified stream doesn’t exist for that request variant.</li>
        <li>Ambiguous selection with conflicting partial fields (e.g. channel mismatch).</li>
      </ul>
      <footer>DMA rules scaffold.</footer>
    </main>
  </body>
</html>
